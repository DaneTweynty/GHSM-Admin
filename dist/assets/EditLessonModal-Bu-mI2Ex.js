import{b as e,e as t,j as s,R as r,I as a,f as n,L as d}from"./chat-CI5uTd2o.js";import{r as l,V as o}from"./ui-CcSG_NNb.js";import{T as i,a as c}from"./management-5vmWAhZ2.js";import"./vendor-DEQ385Nk.js";import"./calendar-Dp5FPTLB.js";const m=({isOpen:m,onClose:x,onSave:u,onMoveToTrash:h,lesson:p,isAddMode:b,instructors:f,students:g,allLessons:v,timeSlots:j})=>{var k,y,N;const[I,w]=l.useState(null),[T,C]=l.useState(null),[S,W]=l.useState(!1),[M,L]=l.useState(!1);l.useRef(null),l.useRef(null);const _=l.useRef(null),R=l.useRef(null),F=l.useMemo(()=>{const s=[];if(0===j.length)return s;let r=j[0];const a=e(j[j.length-1],60);for(;t(r)<=t(a);)s.push(r),r=e(r,1);return s},[j]);if(l.useEffect(()=>{if(p)if(b){const t=g.find(e=>"active"===e.status);w({id:p.id,studentId:(null==t?void 0:t.id)||"",instructorId:f.length>0?f[0].id:"",roomId:p.roomId,date:p.date,time:p.time,endTime:p.endTime||e(p.time,60),notes:p.notes||"",repeatWeekly:!1,repeatWeeks:11})}else w({id:p.id,studentId:p.studentId,instructorId:p.instructorId,roomId:p.roomId,date:p.date,time:p.time,endTime:p.endTime||e(p.time,60),notes:p.notes||"",repeatWeekly:!1,repeatWeeks:11});else w(null);C(null)},[p,b,g,f]),l.useEffect(()=>{if(!m)return;const e=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=e}},[m]),l.useMemo(()=>I?F.filter(e=>t(e)>t(I.time)):F,[F,I]),!m||!I)return null;const $=e=>{const t=e?localStorage.getItem(`ghsm:lastDuration:${e}`):null,s=localStorage.getItem("ghsm:lastDuration:global");return t?parseInt(t,10):s?parseInt(s,10):null},D=s=>{const{name:r,value:a}=s.target;w(s=>{if(!s)return s;if("roomId"===r)return{...s,roomId:parseInt(a)};if("instructorId"===r){const r={...s,instructorId:a},n=$(a);return n&&t(r.time)+n>t(r.time)&&(r.endTime=e(r.time,n)),r}if("time"===r){const r=a,d=s.endTime||e(s.time,60),l=t(d)-t(s.time),o=($(s.instructorId)??l)||60,i=t(r)+Math.max(15,o),c=n(i);return{...s,time:r,endTime:c}}if("endTime"===r){const r=a,n=s.time,o=t(r)>t(n)?r:e(n,15),i=t(o)-t(n);return d=s.instructorId,l=i,d&&localStorage.setItem(`ghsm:lastDuration:${d}`,String(l)),localStorage.setItem("ghsm:lastDuration:global",String(l)),{...s,endTime:o}}var d,l;return{...s,[r]:a}}),C(null)},E=c;return s.jsxs("div",{ref:_,className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex justify-center items-start p-4 overflow-hidden",onClick:x,role:"dialog","aria-modal":"true","aria-labelledby":"edit-lesson-title",children:[(S||M)&&s.jsx("div",{className:"fixed inset-0 z-[9998] bg-transparent",onClick:e=>{e.stopPropagation(),W(!1),L(!1)}}),s.jsx("div",{ref:R,onClick:e=>e.stopPropagation(),className:"w-full max-w-2xl my-4 max-h-[95vh] flex flex-col bg-surface-card dark:bg-slate-800 border border-surface-border dark:border-slate-700 rounded-xl shadow-[0_10px_25px_rgba(0,0,0,0.1),_0_4px_6px_rgba(0,0,0,0.05)] dark:shadow-[0_10px_25px_rgba(0,0,0,0.4),_0_4px_6px_rgba(0,0,0,0.2)]",children:s.jsxs("form",{onSubmit:s=>{if(s.preventDefault(),!I)return;if(b){const e=g.find(e=>e.id===I.studentId);if(!e)return void C("Please select a student.");if("inactive"===e.status){const t=`Student "${e.name}" is not enrolled. Please activate the student to schedule new lessons.`;return C(t),void o.error(t)}}const r={...I,time:I.time,endTime:I.endTime?I.endTime:e(I.time,60)};t(r.endTime)<=t(r.time)&&(r.endTime=e(r.time,15));const a=(s=>{const{id:r,date:a,time:n,endTime:l,instructorId:o,roomId:i,studentId:c}=s,m=t(n),x=t(l||e(n,60)),u=t(d);if(m<u&&u<x)return`Cannot schedule overlapping the lunch break (${d}).`;for(const d of v){if(d.id===r||"deleted"===d.status)continue;if(d.date!==a)continue;const s=t(d.time);if(m<t(d.endTime||e(d.time,60))&&s<x){if(d.instructorId===o){const e=f.find(e=>e.id===o);return`Instructor ${(null==e?void 0:e.name)||""} is already scheduled during this time.`}if(d.roomId===i)return`Room ${i} is already booked during this time.`;if(d.studentId===c){const e=g.find(e=>e.id===c);return`Student ${(null==e?void 0:e.name)||""} already has a lesson during this time.`}}}return null})(r);a?C(a):u(r)},className:"flex flex-col h-full max-h-[95vh]",children:[s.jsx("div",{className:"px-6 py-4 border-b border-surface-border dark:border-slate-700 flex-shrink-0 bg-surface-header/50 dark:bg-slate-700/30 rounded-t-xl",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h2",{id:"edit-lesson-title",className:"text-xl font-bold text-text-primary dark:text-slate-100 mb-1",children:b?"Add New Lesson":"Edit Lesson"}),!b&&s.jsxs("p",{className:"text-sm text-text-secondary dark:text-slate-400",children:["Student: ",s.jsx("span",{className:"font-semibold text-brand-primary dark:text-brand-secondary",children:(null==(k=g.find(e=>e.id===I.studentId))?void 0:k.name)||"Unknown"})]})]}),s.jsx("button",{type:"button",onClick:x,className:"text-text-secondary dark:text-slate-400 hover:text-text-primary dark:hover:text-slate-200 transition-colors p-1 rounded-md hover:bg-surface-hover dark:hover:bg-slate-700","aria-label":"Close modal",children:s.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),s.jsxs("div",{className:"flex-1 overflow-y-auto thin-scroll px-6 py-4",children:[T&&s.jsxs("div",{className:"bg-status-red/10 dark:bg-status-red/20 border border-status-red/20 text-status-red px-4 py-3 rounded-lg mb-4 font-medium flex items-center space-x-2",role:"alert",children:[s.jsx("svg",{className:"w-5 h-5 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),s.jsx("span",{children:T})]}),s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[b?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"md:col-span-2",children:[s.jsxs("label",{htmlFor:"studentId",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:["Student ",s.jsx("span",{className:"text-status-red",children:"*"})]}),s.jsxs(i,{id:"studentId",name:"studentId",value:I.studentId,onChange:D,required:!0,children:[s.jsx("option",{value:"",disabled:!0,children:"Select a student"}),g.sort((e,t)=>e.name.localeCompare(t.name)).map(e=>s.jsxs("option",{value:e.id,children:[e.name," - ",e.instrument," ","inactive"===e.status?"(Not Enrolled)":""]},e.id))]})]}),s.jsxs("div",{className:"md:col-span-2",children:[s.jsxs("label",{htmlFor:"instructorId",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:["Instructor ",s.jsx("span",{className:"text-status-red",children:"*"})]}),s.jsx(i,{id:"instructorId",name:"instructorId",value:I.instructorId,onChange:D,children:f.length>0?f.map(e=>s.jsxs("option",{value:e.id,children:[e.name," (",e.specialty.join(", "),")"]},e.id)):s.jsx("option",{children:"No instructors available"})})]})]}):s.jsxs("div",{className:"md:col-span-2",children:[s.jsxs("label",{htmlFor:"instructorId",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:["Instructor ",s.jsx("span",{className:"text-status-red",children:"*"})]}),s.jsx(i,{id:"instructorId",name:"instructorId",value:I.instructorId,onChange:D,children:f.length>0?f.map(e=>s.jsxs("option",{value:e.id,children:[e.name," (",e.specialty.join(", "),")"]},e.id)):s.jsx("option",{children:"No instructors available"})})]}),s.jsxs("div",{children:[s.jsxs("label",{htmlFor:"date",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:["Date ",s.jsx("span",{className:"text-status-red",children:"*"})]}),s.jsx("input",{type:"date",id:"date",name:"date",value:I.date,onChange:D,className:E,required:!0})]}),s.jsxs("div",{children:[s.jsxs("label",{htmlFor:"time",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:["Start Time ",s.jsx("span",{className:"text-status-red",children:"*"})]}),s.jsx("input",{type:"time",id:"time",name:"time",value:I.time,onChange:D,className:E,required:!0,step:"900",min:"06:00",max:"22:00"}),s.jsx("p",{className:"text-text-secondary dark:text-slate-400 text-sm mt-1",children:"Select time between 6:00 AM and 10:00 PM"})]}),s.jsxs("div",{className:"md:col-span-2",children:[s.jsxs("div",{className:"flex items-baseline justify-between",children:[s.jsx("label",{htmlFor:"endTime",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"End Time"}),I.endTime&&s.jsxs("span",{className:"text-xs "+(t(I.endTime)-t(I.time)<15?"text-status-red":"text-text-secondary"),children:["+",t(I.endTime)-t(I.time)," min"]})]}),s.jsxs("div",{children:[s.jsx("input",{type:"time",id:"endTime",name:"endTime",value:I.endTime||"",onChange:D,className:E,step:"900",min:"06:00",max:"23:00"}),s.jsxs("div",{className:"mt-3 flex gap-2 flex-wrap",children:[s.jsx("span",{className:"text-xs text-text-secondary dark:text-slate-400 self-center mr-2",children:"Quick durations:"}),[30,45,60,90].map(t=>s.jsxs("button",{type:"button",className:"px-3 py-1.5 rounded-md border border-surface-border dark:border-slate-600 text-sm hover:bg-surface-hover dark:hover:bg-slate-700 transition-colors bg-surface-card dark:bg-slate-800",onClick:()=>{const s=e(I.time,t);D({target:{name:"endTime",value:s}})},children:[t,"min"]},t))]}),s.jsx("p",{className:"text-text-secondary dark:text-slate-400 text-sm mt-2",children:"Or use quick duration buttons above"})]})]}),s.jsxs("div",{children:[s.jsxs("label",{htmlFor:"roomId",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:["Room ",s.jsx("span",{className:"text-status-red",children:"*"})]}),s.jsx("input",{type:"number",id:"roomId",name:"roomId",value:I.roomId,onChange:D,min:"1",max:r,className:E,required:!0}),s.jsxs("p",{className:"text-text-secondary dark:text-slate-400 text-sm mt-1",children:["Room number (1-",r,")"]})]})]}),s.jsxs("div",{className:"mt-6 p-4 bg-surface-card dark:bg-slate-800 rounded-lg border border-surface-border dark:border-slate-700 shadow-sm",children:[s.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-3",children:"Lesson Notes"}),s.jsx("textarea",{id:"notes",name:"notes",value:I.notes||"",onChange:D,rows:4,className:`${E} resize-none`,placeholder:"Add specific notes: homework assignments, focus areas, student progress, materials needed..."}),s.jsxs("div",{className:"flex justify-between items-center mt-3",children:[s.jsx("p",{className:"text-xs text-text-tertiary dark:text-slate-500",children:"Use notes for tracking progress and communication with parents"}),s.jsxs("span",{className:"text-xs font-medium "+(((null==(y=I.notes)?void 0:y.length)||0)>500?"text-status-red":"text-text-tertiary dark:text-slate-500"),children:[(null==(N=I.notes)?void 0:N.length)||0,"/500"]})]})]}),s.jsxs("div",{className:"mt-6 p-4 bg-surface-card dark:bg-slate-800 rounded-lg border border-surface-border dark:border-slate-700 shadow-sm",children:[s.jsxs("label",{className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-3",children:["Lesson Type ",s.jsx("span",{className:"text-status-red",children:"*"})]}),s.jsx("div",{className:"space-y-3",children:["Regular","Makeup"].map(e=>s.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-surface-hover dark:hover:bg-slate-700/50 transition-colors group",children:[s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:"radio",name:"lessonType",value:e,checked:I.lessonType===e||!I.lessonType&&"Regular"===e,onChange:e=>w(t=>t?{...t,lessonType:e.target.value}:t),className:"sr-only"}),s.jsx("div",{className:"w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all "+(I.lessonType===e||!I.lessonType&&"Regular"===e?"bg-brand-primary border-brand-primary text-white":"border-surface-border dark:border-slate-600 group-hover:border-brand-primary"),children:(I.lessonType===e||!I.lessonType&&"Regular"===e)&&s.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})]}),s.jsx("span",{className:"text-sm font-medium text-text-primary dark:text-slate-200 group-hover:text-brand-primary transition-colors",children:e})]},e))})]}),s.jsxs("div",{className:"mt-4 space-y-2",children:[s.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors group",children:[s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:"checkbox",name:"repeatWeekly",checked:!!I.repeatWeekly,onChange:e=>w(t=>t?{...t,repeatWeekly:e.target.checked}:t),className:"sr-only"}),s.jsx("div",{className:"w-5 h-5 rounded border-2 flex items-center justify-center transition-all "+(I.repeatWeekly?"bg-blue-500 border-blue-500 text-white":"border-gray-300 dark:border-slate-600 group-hover:border-blue-400"),children:I.repeatWeekly&&s.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})})]}),s.jsx("span",{className:"text-sm font-medium text-text-primary dark:text-slate-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors",children:"Repeat weekly"})]}),I.repeatWeekly&&s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"repeatWeeks",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"Number of additional weeks"}),s.jsx("input",{id:"repeatWeeks",type:"number",min:1,max:52,value:I.repeatWeeks||1,onChange:e=>w(t=>t?{...t,repeatWeeks:Math.max(1,Math.min(52,parseInt(e.target.value||"1")))}:t),className:E})]}),s.jsxs("div",{className:"text-xs text-text-secondary dark:text-slate-400 self-end",children:["Enabling this will also schedule this lesson every week on the same weekday and time for the next ",I.repeatWeeks||1," week(s)."]})]})]})]})]}),s.jsx("div",{className:"px-6 py-4 border-t border-surface-border dark:border-slate-700 flex-shrink-0 bg-surface-header/30 dark:bg-slate-700/20 rounded-b-xl",children:s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("div",{children:!b&&s.jsxs("button",{type:"button",onClick:()=>{p&&h(p.id)},className:"px-4 py-2 rounded-lg font-semibold text-white bg-status-red hover:bg-red-600 transition-colors flex items-center space-x-2 shadow-sm","aria-label":"Move this lesson to the trash",children:[a.trash,s.jsx("span",{children:"Move to Trash"})]})}),s.jsxs("div",{className:"flex space-x-3",children:[s.jsx("button",{type:"button",onClick:x,className:"px-4 py-2 rounded-lg font-semibold text-text-secondary dark:text-slate-300 bg-surface-input dark:bg-slate-600 hover:bg-surface-hover dark:hover:bg-slate-500 transition-colors border border-surface-border dark:border-slate-500",children:"Cancel"}),s.jsx("button",{type:"submit",className:"px-4 py-2 rounded-lg font-semibold text-white bg-brand-primary hover:bg-blue-600 transition-colors shadow-sm",children:b?"Add Lesson":"Save Changes"})]})]})})]})})]})};export{m as EditLessonModal};
