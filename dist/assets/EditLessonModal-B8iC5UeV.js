import{b as e,e as t,j as s,d as r,R as a,I as n,f as l,L as o}from"./chat-Vz45qIYd.js";import{r as d,V as i}from"./ui-CcSG_NNb.js";import{T as c,c as m,s as u,r as h}from"./management-B5-K9R_t.js";import"./vendor-DEQ385Nk.js";import"./calendar-CdK-zQpj.js";const x=({isOpen:x,onClose:p,onSave:b,onMoveToTrash:f,lesson:v,isAddMode:g,instructors:k,students:j,allLessons:y,timeSlots:N})=>{var w;const[I,C]=d.useState(null),[M,T]=d.useState(null),[S,P]=d.useState(!1),[R,A]=d.useState(!1),D=d.useRef(null),W=d.useRef(null),E=d.useRef(null),L=d.useRef(null),F=d.useMemo(()=>{const s=[];if(0===N.length)return s;let r=N[0];const a=e(N[N.length-1],60);for(;t(r)<=t(a);)s.push(r),r=e(r,1);return s},[N]);d.useEffect(()=>{if(v)if(g){const t=j.find(e=>"active"===e.status);C({id:v.id,studentId:(null==t?void 0:t.id)||"",instructorId:k.length>0?k[0].id:"",roomId:v.roomId,date:v.date,time:v.time,endTime:v.endTime||e(v.time,60),notes:v.notes||"",repeatWeekly:!1,repeatWeeks:11})}else C({id:v.id,studentId:v.studentId,instructorId:v.instructorId,roomId:v.roomId,date:v.date,time:v.time,endTime:v.endTime||e(v.time,60),notes:v.notes||"",repeatWeekly:!1,repeatWeeks:11});else C(null);T(null)},[v,g,j,k]),d.useEffect(()=>{if(!x)return;const e=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=e}},[x]);const z=d.useMemo(()=>I?F.filter(e=>t(e)>t(I.time)):F,[F,I]);if(!x||!I)return null;const $=e=>{const t=e?localStorage.getItem(`ghsm:lastDuration:${e}`):null,s=localStorage.getItem("ghsm:lastDuration:global");return t?parseInt(t,10):s?parseInt(s,10):null},_=s=>{const{name:r,value:a}=s.target;C(s=>{if(!s)return s;if("roomId"===r)return{...s,roomId:parseInt(a)};if("instructorId"===r){const r={...s,instructorId:a},n=$(a);return n&&t(r.time)+n>t(r.time)&&(r.endTime=e(r.time,n)),r}if("time"===r){const r=a,n=s.endTime||e(s.time,60),o=t(n)-t(s.time),d=($(s.instructorId)??o)||60,i=t(r)+Math.max(15,d),c=l(i);return{...s,time:r,endTime:c}}if("endTime"===r){const r=a,l=s.time,d=t(r)>t(l)?r:e(l,15),i=t(d)-t(l);return n=s.instructorId,o=i,n&&localStorage.setItem(`ghsm:lastDuration:${n}`,String(o)),localStorage.setItem("ghsm:lastDuration:global",String(o)),{...s,endTime:d}}var n,o;return{...s,[r]:a}}),T(null)},V=m,H=u,B=({value:e,onChange:r,onClose:a,presets:n=[],anchorRef:l,portalRoot:o,scrollParentRef:i})=>{const c=d.useRef(null),[m,u]=d.useState({top:0,left:0}),[x,p]=d.useState(24),[b,f]=d.useState(!1),v=288,g=()=>{const e=null==l?void 0:l.current;if(!e)return;const t=e.getBoundingClientRect();let s=t.left+t.width/2-144;s=Math.max(8,Math.min(s,window.innerWidth-v-8));const r=t.bottom+8;u({top:r,left:s});const a=t.left+t.width/2,n=Math.max(12,Math.min(276,a-s));p(n)};d.useLayoutEffect(()=>{g();const e=()=>g();window.addEventListener("resize",e),window.addEventListener("scroll",e,!0);const t=null==i?void 0:i.current;return null==t||t.addEventListener("scroll",e,{passive:!0}),setTimeout(()=>f(!0),0),()=>{window.removeEventListener("resize",e),window.removeEventListener("scroll",e,!0),null==t||t.removeEventListener("scroll",e)}},[g,i]);const[k,j]=d.useState(()=>t(e)>=720?"PM":"AM"),y=t(e);const N=y%60;let w=Math.floor(y/60)%12;0===w&&(w=12);const[I,C]=d.useState(w),[M,T]=d.useState(N),S=Array.from({length:12},(e,t)=>t+1),P=Array.from({length:60},(e,t)=>t),R=(e=I,t=M,s=k)=>{var n;const o=((e,t,s)=>{let r=e%12;return"PM"===s&&(r+=12),`${String(r).padStart(2,"0")}:${String(t).padStart(2,"0")}`})(e,t,s);r(o),a(),null==(n=null==l?void 0:l.current)||n.focus()};d.useEffect(()=>{var e;null==(e=c.current)||e.focus()},[]);const A=s.jsxs("div",{ref:c,tabIndex:-1,role:"dialog","aria-label":"Time picker",onKeyDown:e=>{var t,s;"Escape"===e.key&&(e.preventDefault(),a(),null==(t=null==l?void 0:l.current)||t.focus()),"Enter"===e.key&&(e.preventDefault(),R()),"ArrowUp"===e.key&&(e.preventDefault(),T(e=>(e+59)%60)),"ArrowDown"===e.key&&(e.preventDefault(),T(e=>(e+1)%60)),"ArrowLeft"===e.key&&(e.preventDefault(),C(e=>(e+10)%12+1)),"ArrowRight"===e.key&&(e.preventDefault(),C(e=>e%12+1)),"Tab"===e.key&&(e.preventDefault(),null==(s=c.current)||s.focus())},style:{position:"fixed",top:m.top,left:m.left,width:v},className:"z-[9999] rounded-md border border-white/10 bg-surface-card dark:bg-slate-800 shadow-2xl ring-1 ring-black/10 outline-none transform transition duration-150 ease-out "+(b?"opacity-100 scale-100":"opacity-0 scale-95"),onClick:e=>e.stopPropagation(),children:[s.jsx("div",{style:{position:"absolute",top:-6,left:x-6},className:"w-3 h-3 rotate-45 bg-surface-card dark:bg-slate-800 border-l border-t border-white/10"}),s.jsxs("div",{className:"p-3 grid grid-cols-[1fr_1fr_auto] gap-2 items-start",children:[s.jsx("div",{className:"max-h-40 overflow-y-auto thin-scroll border border-surface-border dark:border-slate-600 rounded",children:S.map(e=>s.jsx("button",{className:"w-full px-2 py-1 text-left hover:bg-surface-hover dark:hover:bg-slate-700 "+(e===I?"font-semibold bg-surface-hover dark:bg-slate-700":""),onClick:()=>{C(e),R(e,M,k)},children:String(e).padStart(2,"0")},e))}),s.jsx("div",{className:"max-h-40 overflow-y-auto thin-scroll border border-surface-border dark:border-slate-600 rounded",children:P.map(e=>s.jsx("button",{className:"w-full px-2 py-1 text-left hover:bg-surface-hover dark:hover:bg-slate-700 "+(e===M?"font-semibold bg-surface-hover dark:bg-slate-700":""),onClick:()=>{T(e),R(I,e,k)},children:String(e).padStart(2,"0")},e))}),s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsx("button",{type:"button",className:"px-2 py-1 rounded "+("AM"===k?"bg-brand-primary text-text-on-color":"bg-surface-input dark:bg-slate-700"),onClick:()=>j("AM"),children:"AM"}),s.jsx("button",{type:"button",className:"px-2 py-1 rounded "+("PM"===k?"bg-brand-primary text-text-on-color":"bg-surface-input dark:bg-slate-700"),onClick:()=>j("PM"),children:"PM"}),s.jsx("button",{type:"button",className:"mt-2 px-2 py-1 rounded border border-surface-border dark:border-slate-600 hover:bg-surface-hover dark:hover:bg-slate-700",onClick:()=>R(),children:"Apply"})]})]}),n.length>0&&s.jsxs("div",{className:"px-3 pb-3",children:[s.jsx("div",{className:"text-xs mb-1 text-text-secondary dark:text-slate-400",children:"Presets"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:n.map(e=>s.jsx("button",{className:"px-2 py-1 rounded-full border border-surface-border dark:border-slate-600 hover:bg-surface-hover dark:hover:bg-slate-700 text-sm",onClick:()=>R(e.hh,e.mm,e.ampm),children:e.label},e.label))})]})]}),D=(null==o?void 0:o.current)||document.body;return h.createPortal(A,D)};return s.jsxs("div",{ref:E,className:"fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex justify-center items-start p-4 overflow-hidden",onClick:p,role:"dialog","aria-modal":"true","aria-labelledby":"edit-lesson-title",children:[(S||R)&&s.jsx("div",{className:"fixed inset-0 z-[9998] bg-transparent",onClick:e=>{e.stopPropagation(),P(!1),A(!1)}}),s.jsx("div",{ref:L,onClick:e=>e.stopPropagation(),className:"w-full max-w-lg my-8 max-h-[90vh] flex flex-col bg-surface-card dark:bg-slate-800 border border-surface-border dark:border-slate-700 rounded-lg shadow-[0_1px_2px_rgba(16,24,40,0.06),_0_1px_3px_rgba(16,24,40,0.10)] dark:shadow-none",children:s.jsxs("form",{onSubmit:s=>{if(s.preventDefault(),!I)return;if(g){const e=j.find(e=>e.id===I.studentId);if(!e)return void T("Please select a student.");if("inactive"===e.status){const t=`Student "${e.name}" is not enrolled. Please activate the student to schedule new lessons.`;return T(t),void i.error(t)}}const r={...I,time:I.time,endTime:I.endTime?I.endTime:e(I.time,60)};t(r.endTime)<=t(r.time)&&(r.endTime=e(r.time,15));const a=(s=>{const{id:r,date:a,time:n,endTime:l,instructorId:d,roomId:i,studentId:c}=s,m=t(n),u=t(l||e(n,60)),h=t(o);if(m<h&&h<u)return`Cannot schedule overlapping the lunch break (${o}).`;for(const o of y){if(o.id===r||"deleted"===o.status)continue;if(o.date!==a)continue;const s=t(o.time);if(m<t(o.endTime||e(o.time,60))&&s<u){if(o.instructorId===d){const e=k.find(e=>e.id===d);return`Instructor ${(null==e?void 0:e.name)||""} is already scheduled during this time.`}if(o.roomId===i)return`Room ${i} is already booked during this time.`;if(o.studentId===c){const e=j.find(e=>e.id===c);return`Student ${(null==e?void 0:e.name)||""} already has a lesson during this time.`}}}return null})(r);a?T(a):b(r)},className:"flex flex-col h-full max-h-[90vh]",children:[s.jsxs("div",{className:"p-4 border-b border-surface-border dark:border-slate-700 flex-shrink-0",children:[s.jsx("h2",{id:"edit-lesson-title",className:"text-xl font-bold text-text-primary dark:text-slate-100",children:g?"Add New Lesson":"Edit Lesson"}),!g&&s.jsxs("p",{className:"text-text-secondary dark:text-slate-400",children:["Student: ",s.jsx("span",{className:"font-semibold text-brand-secondary",children:(null==(w=j.find(e=>e.id===I.studentId))?void 0:w.name)||"Unknown"})]})]}),s.jsx("div",{className:"flex-1 overflow-y-auto thin-scroll",children:s.jsxs("div",{className:"p-6",children:[M&&s.jsx("div",{className:"bg-status-red-light dark:bg-status-red/20 border border-status-red/20 text-status-red px-4 py-3 rounded-md mb-4 font-medium",role:"alert",children:M}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[g?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("label",{htmlFor:"studentId",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"Student"}),s.jsxs(c,{id:"studentId",name:"studentId",value:I.studentId,onChange:_,required:!0,children:[s.jsx("option",{value:"",disabled:!0,children:"Select a student"}),j.sort((e,t)=>e.name.localeCompare(t.name)).map(e=>s.jsxs("option",{value:e.id,children:[e.name," ","inactive"===e.status?"(Not Enrolled)":""]},e.id))]})]}),s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("label",{htmlFor:"instructorId",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"Instructor"}),s.jsx(c,{id:"instructorId",name:"instructorId",value:I.instructorId,onChange:_,children:k.length>0?k.map(e=>s.jsxs("option",{value:e.id,children:[e.name," (",e.specialty,")"]},e.id)):s.jsx("option",{children:"No instructors available"})})]})]}):s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("label",{htmlFor:"instructorId",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"Instructor"}),s.jsx(c,{id:"instructorId",name:"instructorId",value:I.instructorId,onChange:_,children:k.length>0?k.map(e=>s.jsxs("option",{value:e.id,children:[e.name," (",e.specialty,")"]},e.id)):s.jsx("option",{children:"No instructors available"})})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"date",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"Date"}),s.jsx("input",{type:"date",id:"date",name:"date",value:I.date,onChange:_,className:V})]}),s.jsxs("div",{className:"relative",children:[s.jsx("label",{htmlFor:"time",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"Start Time"}),s.jsxs("div",{className:"relative",children:[s.jsx("select",{id:"time",name:"time",value:I.time,onChange:_,className:H,children:F.map(e=>s.jsx("option",{value:e,children:r(e)},e))}),s.jsx("button",{ref:D,type:"button","aria-label":"Open start time picker",className:"absolute right-2 top-1/2 -translate-y-1/2 text-text-secondary hover:text-brand-primary",onClick:e=>{e.preventDefault(),e.stopPropagation(),P(e=>!e),A(!1)},children:s.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[s.jsx("path",{d:"M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2h-1V3a1 1 0 00-1-1H6z"}),s.jsx("path",{d:"M18 9H2v6a2 2 0 002 2h12a2 2 0 002-2V9z"})]})}),S&&s.jsx(B,{value:I.time,onChange:e=>{_({target:{name:"time",value:e}})},onClose:()=>P(!1),anchorRef:D,portalRoot:E,scrollParentRef:L,presets:[{label:"9 AM",hh:9,mm:0,ampm:"AM"},{label:"12 PM",hh:12,mm:0,ampm:"PM"},{label:"4 PM",hh:4,mm:0,ampm:"PM"},{label:"6 PM",hh:6,mm:0,ampm:"PM"}]})]})]}),s.jsxs("div",{className:"relative",children:[s.jsxs("div",{className:"flex items-baseline justify-between",children:[s.jsx("label",{htmlFor:"endTime",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"End Time"}),I.endTime&&s.jsxs("span",{className:"text-xs "+(t(I.endTime)-t(I.time)<15?"text-status-red":"text-text-secondary"),children:["+",t(I.endTime)-t(I.time)," min"]})]}),s.jsxs("div",{children:[s.jsxs("div",{className:"relative",children:[s.jsx("select",{id:"endTime",name:"endTime",value:I.endTime||"",onChange:_,className:H,children:z.map(e=>s.jsx("option",{value:e,children:r(e)},e))}),s.jsx("button",{ref:W,type:"button","aria-label":"Open end time picker",className:"absolute right-2 top-1/2 -translate-y-1/2 text-text-secondary hover:text-brand-primary",onClick:e=>{e.preventDefault(),e.stopPropagation(),A(e=>!e),P(!1)},children:s.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:[s.jsx("path",{d:"M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2h-1V3a1 1 0 00-1-1H6z"}),s.jsx("path",{d:"M18 9H2v6a2 2 0 002 2h12a2 2 0 002-2V9z"})]})}),R&&s.jsx(B,{value:I.endTime||e(I.time,60),onChange:e=>{_({target:{name:"endTime",value:e}})},onClose:()=>A(!1),anchorRef:W,portalRoot:E,scrollParentRef:L,presets:[{label:"Top of hour",hh:Math.max(1,Math.floor(t(I.time)/60)%12||12),mm:0,ampm:t(I.time)>=720?"PM":"AM"}]})]}),s.jsx("div",{className:"mt-2 flex gap-2",children:[30,45,60].map(t=>s.jsxs("button",{type:"button",className:"px-2 py-1 rounded-full border border-surface-border dark:border-slate-600 text-sm hover:bg-surface-hover dark:hover:bg-slate-700",onClick:()=>{const s=e(I.time,t);_({target:{name:"endTime",value:s}})},children:["+",t,"m"]},t))})]})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"roomId",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"Room"}),s.jsx("input",{type:"number",id:"roomId",name:"roomId",value:I.roomId,onChange:_,min:"1",max:a,className:V})]})]}),s.jsxs("div",{className:"mt-4",children:[s.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"Notes"}),s.jsx("textarea",{id:"notes",name:"notes",value:I.notes||"",onChange:_,rows:3,className:V,placeholder:"Add any specific notes for this lesson..."})]}),s.jsxs("div",{className:"mt-4 space-y-2",children:[s.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors group",children:[s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:"checkbox",name:"repeatWeekly",checked:!!I.repeatWeekly,onChange:e=>C(t=>t?{...t,repeatWeekly:e.target.checked}:t),className:"sr-only"}),s.jsx("div",{className:"w-5 h-5 rounded border-2 flex items-center justify-center transition-all "+(I.repeatWeekly?"bg-blue-500 border-blue-500 text-white":"border-gray-300 dark:border-slate-600 group-hover:border-blue-400"),children:I.repeatWeekly&&s.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})})]}),s.jsx("span",{className:"text-sm font-medium text-text-primary dark:text-slate-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors",children:"Repeat weekly"})]}),I.repeatWeekly&&s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"repeatWeeks",className:"block text-sm font-medium text-text-secondary dark:text-slate-400 mb-1",children:"Number of additional weeks"}),s.jsx("input",{id:"repeatWeeks",type:"number",min:1,max:52,value:I.repeatWeeks||1,onChange:e=>C(t=>t?{...t,repeatWeeks:Math.max(1,Math.min(52,parseInt(e.target.value||"1")))}:t),className:V})]}),s.jsxs("div",{className:"text-xs text-text-secondary dark:text-slate-400 self-end",children:["Enabling this will also schedule this lesson every week on the same weekday and time for the next ",I.repeatWeeks||1," week(s)."]})]})]})]})}),s.jsx("div",{className:"p-4 border-t border-surface-border dark:border-slate-700 flex-shrink-0",children:s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("div",{children:!g&&s.jsxs("button",{type:"button",onClick:()=>{v&&f(v.id)},className:"px-4 py-2 rounded-md font-semibold text-white bg-status-red hover:opacity-90 transition-opacity flex items-center space-x-2","aria-label":"Move this lesson to the trash",children:[n.trash,s.jsx("span",{children:"Move to Trash"})]})}),s.jsxs("div",{className:"flex space-x-3",children:[s.jsx("button",{type:"button",onClick:p,className:"px-4 py-2 rounded-md font-semibold text-text-secondary dark:text-slate-300 bg-surface-input dark:bg-slate-600 hover:brightness-95 dark:hover:bg-slate-500 transition-all",children:"Cancel"}),s.jsx("button",{type:"submit",className:"px-4 py-2 rounded-md font-semibold text-text-on-color bg-brand-primary hover:opacity-90 transition-opacity",children:g?"Add Lesson":"Save Changes"})]})]})})]})})]})};export{x as EditLessonModal};
